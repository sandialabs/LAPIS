macro(AddPythonTest name)
  add_test(NAME ${name} WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR} COMMAND ${Python3_EXECUTABLE} ${name}.py)
  # All the python-based tests use the same (default) workspace directory, lapis_package/
  # So they must be run sequentially
  set_tests_properties(${name} PROPERTIES RUN_SERIAL TRUE)
endmacro()

IF(MLIR_ENABLE_BINDINGS_PYTHON)
  IF(NOT DEFINED Python3_EXECUTABLE)
    MESSAGE(WARNING "MLIR's python bindings were enabled, but Python3_EXECUTABLE is not set. Will not be able to enable LAPIS's python tests")
  ELSE()
    AddPythonTest(spmm_dcsr_opdsl)
    AddPythonTest(spmv_noalloc)
    AddPythonTest(multiple_results)
    AddPythonTest(scalar_args)
    AddPythonTest(while)
    AddPythonTest(pcg_solve)
    IF(LAPIS_HAS_TORCH_MLIR)
      MESSAGE(STATUS "Enabling LAPIS's torch-mlir based python tests")
      AddPythonTest(gemm)
      AddPythonTest(gemm_no_alloc)
      AddPythonTest(batched_gemm)
      AddPythonTest(batched_gemm_no_alloc)
      AddPythonTest(matadd)
      AddPythonTest(resnet18_static)
      AddPythonTest(resnet18_dynamic)
      AddPythonTest(twomodules)
    ENDIF()
    IF(LAPIS_HAS_MPACT)
      MESSAGE(STATUS "Enabling LAPIS's MPACT based python tests")
      AddPythonTest(spmv)
      AddPythonTest(spmv_sparsetensor)
    ENDIF()
  ENDIF()
ENDIF()
